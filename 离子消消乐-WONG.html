<!DOCTYPE html>
<html lang="zh-CN">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš—ï¸</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="åŒ–å­¦ç¦»å­æ¶ˆæ¶ˆä¹æ¸¸æˆ - é€šè¿‡æ¶ˆé™¤ä¸å…±å­˜çš„ç¦»å­æ¥è·å¾—é«˜åˆ†ï¼">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»å­æ¶ˆæ¶ˆä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
        }
        
        body {
            background-color: #FFF8F0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: linear-gradient(to bottom, #FFF8F0, #FFE8D0);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            font-size: 42px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .game-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-gap: 15px;
            width: 800px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 400px;
        }
        
        .ion-bubble {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                inset 0 -8px 20px rgba(0, 0, 0, 0.2),
                inset 0 8px 20px rgba(255, 255, 255, 0.5),
                0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .ion-bubble::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 20%;
            width: 30px;
            height: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transform: rotate(-30deg);
        }
        
        .ion-bubble.selected {
            transform: scale(1.1);
            box-shadow: 
                inset 0 -8px 20px rgba(0, 0, 0, 0.2),
                inset 0 8px 20px rgba(255, 255, 255, 0.5),
                0 0 20px 5px rgba(255, 255, 100, 0.8);
            animation: none;
        }
        
        .ion-name {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .ion-charge {
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            margin-top: 5px;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 30px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(to bottom, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: linear-gradient(to bottom, #cccccc, #999999);
            cursor: not-allowed;
        }
        
        #reset-btn {
            background: linear-gradient(to bottom, #FF6B6B, #C44D4D);
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            z-index: 100;
            display: none;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .instructions {
            margin-top: 20px;
            text-align: center;
            color: #555;
            max-width: 800px;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .sound-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        .sound-control i {
            font-size: 24px;
            color: #333;
        }

        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .victory-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        .victory-content h2 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .victory-content p {
            font-size: 24px;
            margin: 10px 0;
        }

        .victory-content button {
            margin-top: 20px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="sound-control" id="sound-toggle">
        <i>ğŸ”Š</i>
    </div>
    
    <div class="header">
        <h1>ç¦»å­æ¶ˆæ¶ˆä¹</h1>
    </div>
    
    <div class="game-info">
        <div class="score">åˆ†æ•°: <span id="score">0</span></div>
        <div class="moves">å‰©ä½™æ­¥æ•°: <span id="moves">100</span></div>
        <div class="timer">å‰©ä½™æ—¶é—´: <span id="timer">05:00</span></div>
    </div>
    
    <div class="game-container" id="game-container">
        <!-- ç¦»å­æ³¡æ³¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="controls">
        <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
        <button id="reset-btn">é‡æ–°å¼€å§‹</button>
    </div>
    
    <div class="instructions">
        <p>æ¸¸æˆè§„åˆ™ï¼šç‚¹å‡»ä¸¤ä¸ªä¸å…±å­˜çš„ç¦»å­ï¼ˆä¼šç”Ÿæˆæ²‰æ·€ã€æ°”ä½“æˆ–å‘ç”Ÿæ°§åŒ–è¿˜åŸååº”çš„ç¦»å­å¯¹ï¼‰ï¼Œä¸¤ä¸ªæ³¡æ³¡å°±ä¼šæ¶ˆå¤±ã€‚</p>
        <p>æˆåŠŸæ¶ˆé™¤ä¸€å¯¹å¾—20åˆ†ï¼Œå…¨éƒ¨æ¶ˆé™¤åæ¸¸æˆèƒœåˆ©ï¼æ¯ç‚¹å‡»ä¸€æ¬¡æ³¡æ³¡å‡å°‘ä¸€æ­¥ã€‚</p>
    </div>
    
    <div class="message" id="message"></div>

    <div class="victory-screen" id="victory-screen">
        <div class="victory-content">
            <h2>ğŸ‰ æ¸¸æˆèƒœåˆ©ï¼ ğŸ‰</h2>
            <p>æœ€ç»ˆåˆ†æ•°: <span id="final-score">0</span></p>
            <p>å‰©ä½™æ—¶é—´: <span id="final-time">00:00</span></p>
            <p>å‰©ä½™æ­¥æ•°: <span id="final-moves">0</span></p>
            <p>æ­å–œä½ æˆåŠŸè®©æ‰€æœ‰ç¦»å­å…±å­˜ï¼</p>
            <button id="play-again-btn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
    
    <script>
        // ========== æ¸¸æˆæ•°æ®å®šä¹‰ ==========
        
        // ç¦»å­æ•°æ® - æ ¼å¼ä¸º [åç§°, é¢œè‰², ç”µè·]
        const IONS = [
            // é˜³ç¦»å­
            ["Hâº", "#6496FF", ""],    // 0
            ["Kâº", "#64C8FF", ""],     // 1
            ["Naâº", "#C8C8FF", ""],    // 2
            ["CaÂ²âº", "#FFC864", ""],   // 3
            ["MgÂ²âº", "#FFB464", ""],   // 4
            ["AlÂ³âº", "#FF9696", ""],   // 5
            ["FeÂ³âº", "#FF6464", ""],   // 6
            ["CuÂ²âº", "#64C864", ""],   // 7
            ["Agâº", "#C8C8C8", ""],    // 8
            ["BaÂ²âº", "#C896FF", ""],   // 9
            ["NHâ‚„âº", "#96C896", ""],   // 10
            ["ZnÂ²âº", "#B4B4C8", ""],   // 11
            ["PbÂ²âº", "#969696", ""],   // 12
            ["HgÂ²âº", "#C896C8", ""],   // 13
            ["NiÂ²âº", "#64C896", ""],   // 14
            ["CrÂ³âº", "#649664", ""],   // 15
            ["FeÂ²âº", "#C89664", ""],   // 16
            
            // é˜´ç¦»å­
            ["Clâ»", "#FFFF96", ""],    // 17
            ["Brâ»", "#C8FF96", ""],    // 18
            ["Iâ»", "#B4FFB4", ""],     // 19
            ["SOâ‚ƒÂ²â»", "#FF96FF", ""],  // 20
            ["COâ‚ƒÂ²â»", "#96FFFF", ""],  // 21
            ["SiOâ‚ƒÂ²â»", "#C8C8FF", ""],   // 22
            ["OHâ»", "#FFC8FF", ""],    // 23
            ["POâ‚„Â³â»", "#FF9696", ""],  // 24
            ["SÂ²â»", "#9696C8", ""],    // 25
            ["Fâ»", "#DCFFDC", ""],     // 26
            ["MnOâ‚„â»", "#FF6496", ""],  // 27
            ["CrOâ‚„Â²â»", "#FFC832", ""], // 28 - å·²åŠ å…¥é»‘åå•
            ["Crâ‚‚Oâ‚‡Â²â»", "#FF9632", ""],// 29
            ["ClOâ»", "#C8DCFF", ""],   // 30
            ["HNOâ‚ƒ", "#FFC8C8", ""],   // 31
            ["HCOâ‚ƒâ»", "#C8FFE6", ""],   // 32
            ["[Al(OH)â‚„]â»", "#C8FFE6", ""]   // 33
        ];

        // ä¸å…±å­˜è§„åˆ™ - ç¦»å­å¯¹ç´¢å¼• (ç´¢å¼•å¯¹åº”IONSåˆ—è¡¨)
        const INCOMPATIBLE_PAIRS = [
            // ç”Ÿæˆæ²‰æ·€çš„ç¦»å­å¯¹
            [3, 21], // CaÂ²âº + COâ‚ƒÂ²â» â†’ CaCOâ‚ƒâ†“
            [4, 21], [4, 20], // MgÂ²âº + COâ‚ƒÂ²â» â†’ MgCOâ‚ƒâ†“
            [3, 20],  // CaÂ²âº + SOâ‚„Â²â» â†’ CaSOâ‚„â†“
            [9, 20], [9, 21], // BaÂ²âº + SOâ‚„Â²â» â†’ BaSOâ‚„â†“
            [8, 17],  // Agâº + Clâ» â†’ AgClâ†“
            [8, 18],  // Agâº + Brâ» â†’ AgBrâ†“
            [8, 19],  // Agâº + Iâ» â†’ AgIâ†“
            [5, 23],  // AlÂ³âº + OHâ» â†’ Al(OH)â‚ƒâ†“
            [6, 23],  // FeÂ³âº + OHâ» â†’ Fe(OH)â‚ƒâ†“
            [3, 23],  // CaÂ²âº + OHâ» â†’ Ca(OH)â‚‚â†“ (å¾®æº¶)
            [4, 23],  // MgÂ²âº + OHâ» â†’ Mg(OH)â‚‚â†“
            [7, 23],  // CuÂ²âº + OHâ» â†’ Cu(OH)â‚‚â†“
            [9, 24],  // BaÂ²âº + POâ‚„Â³â» â†’ Baâ‚ƒ(POâ‚„)â‚‚â†“
            [3, 24],  // CaÂ²âº + POâ‚„Â³â» â†’ Caâ‚ƒ(POâ‚„)â‚‚â†“
            [6, 24],  // FeÂ³âº + POâ‚„Â³â» â†’ FePOâ‚„â†“
            [11, 23], // ZnÂ²âº + OHâ» â†’ Zn(OH)â‚‚â†“
            [12, 23], // PbÂ²âº + OHâ» â†’ Pb(OH)â‚‚â†“
            [13, 23], // HgÂ²âº + OHâ» â†’ HgOâ†“ + Hâ‚‚O
            [14, 23], // NiÂ²âº + OHâ» â†’ Ni(OH)â‚‚â†“
            [15, 23], // CrÂ³âº + OHâ» â†’ Cr(OH)â‚ƒâ†“
            [16, 23], // FeÂ²âº + OHâ» â†’ Fe(OH)â‚‚â†“
            
            [3, 26], [4, 26], [5, 26], [6, 26], [9, 26], [11, 26], [12, 26], [14, 26], [15, 26],   // + Fâ» â†’ ç”Ÿæˆæ²‰æ·€

            [0, 22], [3, 22], [4, 22], [5, 22], [6, 22], [7, 22], [8, 22], [9, 22], [11, 22], [12, 22], [13, 22], [14, 22], [15, 22], [16, 22],  // +SiOâ‚ƒÂ²â» â†’ ç”Ÿæˆæ²‰æ·€
            [0, 21], [3, 21], [4, 21], [5, 21], [6, 21], [7, 21], [8, 21], [9, 21], [11, 21], [12, 21], [13, 21], [14, 21], [15, 21], [16, 21],  // +COâ‚ƒÂ²â» â†’ ç”Ÿæˆæ²‰æ·€
            [0, 20], [3, 20], [4, 20], [5, 20], [6, 20], [7, 20], [8, 20], [9, 20], [11, 20], [12, 20], [13, 20], [14, 20], [15, 20], [16, 20],  // +SOâ‚ƒÂ²â» â†’ ç”Ÿæˆæ²‰æ·€
            [8, 17], [8, 18], [8, 19], [8, 20], [8, 21], [8, 22], [8, 23], [8, 24], [8, 25], [8, 28], [8, 32],  // +Agâºâ» â†’ ç”Ÿæˆæ²‰æ·€

            [0, 33],  [31, 33], [32, 33], 

            // å‘ç”Ÿæ°§åŒ–è¿˜åŸçš„ç¦»å­å¯¹
            [6, 19], [6, 20], [6, 25],
            [27, 20], [27, 25], [27, 19], [27, 16], [27, 17],
            [29, 20], [29, 25], [29, 19], [29, 16],
            [30, 20], [30, 25], [30, 19], [30, 16],
            [31, 20], [31, 25], [31, 19], [31, 16],

            // é…¸ç¢±ä¸å…±å­˜
            [23, 0],  // Hâº + OHâ» â†’ Hâ‚‚O
            [23, 4],  // MgÂ²âº + OHâ» â†’ Mg(OH)â‚‚â†“
            [23, 5],  // AlÂ³âº + OHâ» â†’ Al(OH)â‚ƒâ†“
            [23, 6],  // FeÂ³âº + OHâ» â†’ Fe(OH)â‚ƒâ†“
            [23, 7],  // CuÂ²âº + OHâ» â†’ Cu(OH)â‚‚â†“
            [23, 8],  // Agâº + OHâ» â†’ Agâ‚‚Oâ†“ + Hâ‚‚O
            [23, 10],  // NHâ‚„âº + OHâ» â†’ NHâ‚ƒâ†‘ + Hâ‚‚O
            [23, 11],  // ZnÂ²âº + OHâ» â†’ Zn(OH)â‚‚â†“
            [23, 12],  // PbÂ²âº + OHâ» â†’ Pb(OH)â‚‚â†“
            [23, 13],  // HgÂ²âº + OHâ» â†’ HgOâ†“ + Hâ‚‚O
            [23, 14],  // NiÂ²âº + OHâ» â†’ Ni(OH)â‚‚â†“
            [23, 15],  // CrÂ³âº + OHâ» â†’ Cr(OH)â‚ƒâ†“
            [23, 16],  // FeÂ²âº + OHâ» â†’ Fe(OH)â‚‚â†“
            [23, 32],
            [0, 20], [0, 21], [0, 22], [0, 23], [0, 24], [0, 25], [0, 26], [0, 28], [0, 30], [0, 32], [0, 33],

            // å®Œå…¨åŒæ°´è§£
            [5, 21],  // AlÂ³âº + COâ‚ƒÂ²â»
            [5, 20],  // AlÂ³âº + SOâ‚„Â²â»
            [5, 22],  // AlÂ³âº + SiOâ‚ƒÂ²â»
            [5, 25],  // AlÂ³âº + SÂ²â»
            [5, 30],  // AlÂ³âº + ClOâ»
            [5, 32],  // AlÂ³âº + HCO3â»
            [5, 33],  // AlÂ³âº + [Al(OH)â‚„]â»
            [6, 21],  // FeÂ³âº + COâ‚ƒÂ²â»
            [6, 20],  // FeÂ³âº + SOâ‚„Â²â»
            [6, 22],  // FeÂ³âº + SiOâ‚ƒÂ²â»
            [6, 25],  // FeÂ³âº + SÂ²â»
            [6, 30],  // FeÂ³âº + ClOâ»
            [6, 32],  // FeÂ³âº + HCO3â»
            [6, 33],  // FeÂ³âº + [Al(OH)â‚„]â»
            [10, 22],  // NHâ‚„âº +  SiOâ‚ƒÂ²â»
            [10, 33],  // NHâ‚„âº + [Al(OH)â‚„]â»

            // SÂ²â»ä¸Hgã€Feã€Cuã€Znç­‰ç¦»å­ä¸å…±å­˜
            [25, 4], [25, 5], [25, 6], [25, 7], [25, 8], [25, 11], [25, 12], [25, 13], [25, 14], [25, 15], [25, 16]
        ];

        // ä¸å…è®¸å‡ºç°çš„ç¦»å­ç´¢å¼•ï¼ˆé»‘åå•ï¼‰- åŒ…æ‹¬CrOâ‚„Â²â» (ç´¢å¼•28)
        const BANNED_IONS = [12, 15, 24, 31];

        // ========== æ¸¸æˆçŠ¶æ€å’ŒDOMå…ƒç´  ==========
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            grid: [],           // æ¸¸æˆç½‘æ ¼
            selected: null,     // å½“å‰é€‰ä¸­çš„ç¦»å­
            score: 0,           // å½“å‰åˆ†æ•°
            moves: 100,         // å‰©ä½™æ­¥æ•°
            timeLeft: 300,      // å‰©ä½™æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼Œå•ä½ï¼šç§’ï¼‰
            gameStarted: false, // æ¸¸æˆæ˜¯å¦å¼€å§‹
            soundEnabled: true, // å£°éŸ³æ˜¯å¦å¼€å¯
            ionCounts: {},      // è®°å½•æ¯ä¸ªç¦»å­å‡ºç°çš„æ¬¡æ•°
            positions: [],      // è®°å½•æ¯ä¸ªæ³¡æ³¡çš„ä½ç½®
            bubbleCounter: 0,   // æ³¡æ³¡è®¡æ•°å™¨
            timerInterval: null // è®¡æ—¶å™¨å¼•ç”¨
        };

        // DOMå…ƒç´ 
        const gameContainer = document.getElementById('game-container');
        const scoreElement = document.getElementById('score');
        const movesElement = document.getElementById('moves');
        const timerElement = document.getElementById('timer');
        const startButton = document.getElementById('start-btn');
        const resetButton = document.getElementById('reset-btn');
        const messageElement = document.getElementById('message');
        const soundToggle = document.getElementById('sound-toggle');
        const victoryScreen = document.getElementById('victory-screen');
        const finalScoreElement = document.getElementById('final-score');
        const finalTimeElement = document.getElementById('final-time');
        const finalMovesElement = document.getElementById('final-moves');
        const playAgainButton = document.getElementById('play-again-btn');

        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        let audioContext;

        // ========== éŸ³é¢‘åŠŸèƒ½ ==========
        
        // åˆå§‹åŒ–éŸ³é¢‘
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log("Web Audio API is not supported in this browser");
                gameState.soundEnabled = false;
                soundToggle.style.display = 'none';
            }
        }

        // æ’­æ”¾å£°éŸ³
        function playSound(type) {
            if (!gameState.soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // è®¾ç½®éŸ³é¢‘å‚æ•°
            switch(type) {
                case 'correct':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.exponentialRampToValueAtTime(659.25, audioContext.currentTime + 0.2); // E5
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                    
                case 'wrong':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
                    oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.3); // A2
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                    
                case 'victory':
                    // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ - ä¸€å°æ®µæ—‹å¾‹
                    const now = audioContext.currentTime;
                    
                    // ç¬¬ä¸€ä¸ªéŸ³ç¬¦
                    const osc1 = audioContext.createOscillator();
                    const gain1 = audioContext.createGain();
                    osc1.connect(gain1);
                    gain1.connect(audioContext.destination);
                    osc1.type = 'sine';
                    osc1.frequency.setValueAtTime(523.25, now); // C5
                    gain1.gain.setValueAtTime(0, now);
                    gain1.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    gain1.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc1.start(now);
                    osc1.stop(now + 0.3);
                    
                    // ç¬¬äºŒä¸ªéŸ³ç¬¦
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(659.25, now + 0.2); // E5
                    gain2.gain.setValueAtTime(0, now + 0.2);
                    gain2.gain.linearRampToValueAtTime(0.3, now + 0.3);
                    gain2.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc2.start(now + 0.2);
                    osc2.stop(now + 0.5);
                    
                    // ç¬¬ä¸‰ä¸ªéŸ³ç¬¦
                    const osc3 = audioContext.createOscillator();
                    const gain3 = audioContext.createGain();
                    osc3.connect(gain3);
                    gain3.connect(audioContext.destination);
                    osc3.type = 'sine';
                    osc3.frequency.setValueAtTime(783.99, now + 0.4); // G5
                    gain3.gain.setValueAtTime(0, now + 0.4);
                    gain3.gain.linearRampToValueAtTime(0.3, now + 0.5);
                    gain3.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc3.start(now + 0.4);
                    osc3.stop(now + 0.8);
                    
                    // ç¬¬å››ä¸ªéŸ³ç¬¦
                    const osc4 = audioContext.createOscillator();
                    const gain4 = audioContext.createGain();
                    osc4.connect(gain4);
                    gain4.connect(audioContext.destination);
                    osc4.type = 'sine';
                    osc4.frequency.setValueAtTime(1046.50, now + 0.6); // C6
                    gain4.gain.setValueAtTime(0, now + 0.6);
                    gain4.gain.linearRampToValueAtTime(0.3, now + 0.7);
                    gain4.gain.linearRampToValueAtTime(0, now + 1.2);
                    osc4.start(now + 0.6);
                    osc4.stop(now + 1.2);
                    break;
            }
        }

        // ========== æ¸¸æˆæ ¸å¿ƒåŠŸèƒ½ ==========
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.grid = [];
            gameState.selected = null;
            gameState.score = 0;
            gameState.moves = 100;
            gameState.timeLeft = 300;
            gameState.gameStarted = false;
            gameState.ionCounts = {};
            gameState.positions = [];
            gameState.bubbleCounter = 0;
            
            // æ¸…é™¤è®¡æ—¶å™¨
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            scoreElement.textContent = gameState.score;
            movesElement.textContent = gameState.moves;
            timerElement.textContent = formatTime(gameState.timeLeft);
            
            // æ¸…ç©ºæ¸¸æˆå®¹å™¨
            gameContainer.innerHTML = '';
            
            // éšè—èƒœåˆ©ç•Œé¢
            victoryScreen.style.display = 'none';
            
            // åˆ›å»ºåˆå§‹çš„36ä¸ªç¦»å­æ³¡æ³¡ (6x6)
            for (let i = 0; i < 36; i++) {
                createIonBubble(i);
            }
            
            // éšè—æ¶ˆæ¯
            hideMessage();
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                timerElement.textContent = formatTime(gameState.timeLeft);
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    gameOver('æ—¶é—´åˆ°ï¼æ¸¸æˆç»“æŸ');
                }
            }, 1000);
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // è·å–éšæœºç¦»å­ç´¢å¼•ï¼ˆæ’é™¤é»‘åå•ä¸­çš„ç¦»å­ï¼ŒHâºå’ŒOHâ»ä¸å—é™åˆ¶ï¼‰
        function getRandomIonIndex() {
            let index;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                index = Math.floor(Math.random() * IONS.length);
                attempts++;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆï¼ˆHâºå’ŒOHâ»ä¸å—æ¬¡æ•°é™åˆ¶ï¼‰
                const isUnlimitedIon = index === 0 || index === 23; // 0æ˜¯Hâº, 23æ˜¯OHâ»
                const isValid = !BANNED_IONS.includes(index) && 
                               (isUnlimitedIon || !gameState.ionCounts[index] || gameState.ionCounts[index] < 1);
                
                if (isValid) {
                    // æ›´æ–°è®¡æ•°
                    if (!gameState.ionCounts[index]) {
                        gameState.ionCounts[index] = 0;
                    }
                    gameState.ionCounts[index]++;
                    return index;
                }
                
            } while (attempts < maxAttempts);
            
            // å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„
            for (let i = 0; i < IONS.length; i++) {
                const isUnlimited = i === 0 || i === 23; // 0æ˜¯Hâº, 23æ˜¯OHâ»
                if (!BANNED_IONS.includes(i) && (isUnlimited || !gameState.ionCounts[i] || gameState.ionCounts[i] < 1)) {
                    if (!gameState.ionCounts[i]) gameState.ionCounts[i] = 0;
                    gameState.ionCounts[i]++;
                    return i;
                }
            }
            
            // å®åœ¨æ‰¾ä¸åˆ°ï¼Œè¿”å›0
            return 0;
        }

        // åˆ›å»ºç¦»å­æ³¡æ³¡
        function createIonBubble(index) {
            const ionIndex = getRandomIonIndex();
            const ion = IONS[ionIndex];
            
            // åˆ›å»ºæ³¡æ³¡å…ƒç´ 
            const bubble = document.createElement('div');
            bubble.className = 'ion-bubble';
            bubble.style.background = `radial-gradient(circle at 30% 30%, ${lightenColor(ion[1], 30)}, ${ion[1]})`;
            bubble.dataset.index = ionIndex;
            bubble.dataset.id = index;
            
            // æ·»åŠ åˆ°æ¸¸æˆå®¹å™¨
            gameContainer.appendChild(bubble);
            
            // æ·»åŠ ç¦»å­åç§°å’Œç”µè·
            const nameElement = document.createElement('div');
            nameElement.className = 'ion-name';
            nameElement.textContent = ion[0];
            
            const chargeElement = document.createElement('div');
            chargeElement.className = 'ion-charge';
            chargeElement.textContent = ion[2];
            
            bubble.appendChild(nameElement);
            bubble.appendChild(chargeElement);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            bubble.addEventListener('click', () => handleBubbleClick(bubble, ionIndex));
            
            // å­˜å‚¨æ³¡æ³¡ä¿¡æ¯
            gameState.positions[index] = { 
                bubble, 
                ionIndex
            };
            
            // å¢åŠ æ³¡æ³¡è®¡æ•°å™¨
            gameState.bubbleCounter++;
        }

        // å¤„ç†æ³¡æ³¡ç‚¹å‡»
        function handleBubbleClick(bubble, ionIndex) {
            // å¦‚æœæ¸¸æˆæœªå¼€å§‹ï¼Œä¸å¤„ç†ç‚¹å‡»
            if (!gameState.gameStarted) return;
            
            // å¦‚æœæ³¡æ³¡å·²ç»è¢«æ¶ˆé™¤ï¼Œä¸å¤„ç†ç‚¹å‡»
            if (bubble.style.opacity === '0') return;
            
            // æ¯æ¬¡ç‚¹å‡»éƒ½å‡å°‘æ­¥æ•°
            gameState.moves--;
            movesElement.textContent = gameState.moves;
            
            if (gameState.selected === null) {
                // ç¬¬ä¸€æ¬¡é€‰æ‹©
                gameState.selected = { bubble, ionIndex };
                bubble.classList.add('selected');
            } else {
                // ç¬¬äºŒæ¬¡é€‰æ‹©
                const firstSelected = gameState.selected;
                const areIncompatible = checkIncompatibility(firstSelected.ionIndex, ionIndex);
                
                if (areIncompatible) {
                    // æˆåŠŸåŒ¹é…
                    playSound('correct');
                    
                    // ç§»é™¤æ³¡æ³¡
                    removeBubble(firstSelected.bubble);
                    removeBubble(bubble);
                    
                    // æ›´æ–°åˆ†æ•°
                    gameState.score += 20;
                    scoreElement.textContent = gameState.score;
                    
                    // æ·»åŠ ä¸€ä¸ªæ–°çš„ç¦»å­æ³¡æ³¡
                    setTimeout(() => {
                        addNewIonBubble();
                    }, 500);
                    
                    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                    setTimeout(() => {
                        checkGameEnd();
                    }, 1000);
                } else {
                    // åŒ¹é…å¤±è´¥
                    playSound('wrong');
                    bubble.classList.add('selected');
                    
                    // çŸ­æš‚æ˜¾ç¤ºé€‰æ‹©çŠ¶æ€åé‡ç½®
                    setTimeout(() => {
                        firstSelected.bubble.classList.remove('selected');
                        bubble.classList.remove('selected');
                    }, 500);
                }
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                gameState.selected = null;
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆæ­¥æ•°ç”¨å°½ï¼‰
                if (gameState.moves <= 0) {
                    setTimeout(() => {
                        checkGameEnd();
                    }, 500);
                }
            }
        }

        // æ£€æŸ¥ä¸¤ä¸ªç¦»å­æ˜¯å¦ä¸å…±å­˜
        function checkIncompatibility(ion1, ion2) {
            for (const pair of INCOMPATIBLE_PAIRS) {
                if ((pair[0] === ion1 && pair[1] === ion2) || 
                    (pair[0] === ion2 && pair[1] === ion1)) {
                    return true;
                }
            }
            return false;
        }

        // ç§»é™¤æ³¡æ³¡
        function removeBubble(bubble) {
            // æ·»åŠ æ¶ˆå¤±åŠ¨ç”»
            bubble.style.transition = 'all 0.5s ease';
            bubble.style.opacity = '0';
            bubble.style.transform = 'scale(0)';
            
            // ä»ç¦»å­è®¡æ•°ä¸­å‡å»
            const ionIndex = parseInt(bubble.dataset.index);
            if (gameState.ionCounts[ionIndex]) {
                gameState.ionCounts[ionIndex]--;
            }
            
            // ä»positionsä¸­ç§»é™¤
            const id = parseInt(bubble.dataset.id);
            gameState.positions[id] = null;
            
            // å»¶è¿Ÿç§»é™¤DOMå…ƒç´ 
            setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.parentNode.removeChild(bubble);
                }
            }, 500);
        }

        // æ·»åŠ æ–°çš„ç¦»å­æ³¡æ³¡
        function addNewIonBubble() {
            // æŸ¥æ‰¾ç©ºä½ç½®
            let emptyIndex = -1;
            for (let i = 0; i < gameState.positions.length; i++) {
                if (!gameState.positions[i]) {
                    emptyIndex = i;
                    break;
                }
            }
            
            // å¦‚æœæ²¡æœ‰ç©ºä½ç½®ï¼Œæ·»åŠ åˆ°æœ«å°¾
            if (emptyIndex === -1) {
                emptyIndex = gameState.positions.length;
            }
            
            // åˆ›å»ºæ–°çš„æ³¡æ³¡
            createIonBubble(emptyIndex);
        }

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        function checkGameEnd() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç¦»å­éƒ½å…±å­˜
            if (areAllIonsCompatible()) {
                showVictoryScreen();
                return;
            }
            
            // æ£€æŸ¥æ­¥æ•°æˆ–æ—¶é—´æ˜¯å¦ç”¨å°½
            if (gameState.moves <= 0) {
                gameOver('æ­¥æ•°ç”¨å°½ï¼æ¸¸æˆç»“æŸ');
            }
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç¦»å­éƒ½å…±å­˜
        function areAllIonsCompatible() {
            const bubbles = document.querySelectorAll('.ion-bubble');
            const visibleBubbles = Array.from(bubbles).filter(bubble => 
                bubble.style.opacity !== '0' && getComputedStyle(bubble).display !== 'none'
            );
            
            // å¦‚æœæ³¡æ³¡æ•°é‡ä¸º0ï¼Œè¯´æ˜æ¸¸æˆèƒœåˆ©
            if (visibleBubbles.length === 0) {
                return true;
            }
            
            // æ£€æŸ¥æ‰€æœ‰å¯è§æ³¡æ³¡ä¹‹é—´æ˜¯å¦éƒ½å…±å­˜
            for (let i = 0; i < visibleBubbles.length; i++) {
                for (let j = i + 1; j < visibleBubbles.length; j++) {
                    const ion1 = parseInt(visibleBubbles[i].dataset.index);
                    const ion2 = parseInt(visibleBubbles[j].dataset.index);
                    
                    if (checkIncompatibility(ion1, ion2)) {
                        return false; // å‘ç°ä¸å…±å­˜çš„ç¦»å­å¯¹
                    }
                }
            }
            
            return true; // æ‰€æœ‰ç¦»å­éƒ½å…±å­˜
        }

        // æ˜¾ç¤ºèƒœåˆ©ç•Œé¢
        function showVictoryScreen() {
            clearInterval(gameState.timerInterval);
            playSound('victory');
            
            finalScoreElement.textContent = gameState.score;
            finalTimeElement.textContent = formatTime(300 - gameState.timeLeft);
            finalMovesElement.textContent = gameState.moves;
            
            victoryScreen.style.display = 'flex';
            gameState.gameStarted = false;
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(message) {
            clearInterval(gameState.timerInterval);
            showMessage(message);
            gameState.gameStarted = false;
        }

        // ========== è¾…åŠ©åŠŸèƒ½ ==========
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text) {
            messageElement.textContent = text;
            messageElement.style.display = 'block';
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            messageElement.style.display = 'none';
        }

        // é¢œè‰²å˜äº®å‡½æ•°
        function lightenColor(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            
            return "#" + (
                0x1000000 + 
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 + 
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 + 
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        
        startButton.addEventListener('click', () => {
            gameState.gameStarted = true;
            startButton.disabled = true;
            startButton.textContent = 'æ¸¸æˆä¸­...';
            startTimer();
        });

        resetButton.addEventListener('click', () => {
            initGame();
            startButton.disabled = false;
            startButton.textContent = 'å¼€å§‹æ¸¸æˆ';
        });

        soundToggle.addEventListener('click', () => {
            gameState.soundEnabled = !gameState.soundEnabled;
            soundToggle.innerHTML = gameState.soundEnabled ? '<i>ğŸ”Š</i>' : '<i>ğŸ”‡</i>';
        });

        playAgainButton.addEventListener('click', () => {
            initGame();
        });

        // ========== åˆå§‹åŒ–æ¸¸æˆ ==========
        
        initAudio();
        initGame();
    </script>
</body>
</html>