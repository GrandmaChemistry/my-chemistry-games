<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„é€ åŸç†é…’åº—æ¸¸æˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            position: relative;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #bbbbff;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .top-controls {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .rules-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .rules-panel h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .rules-panel ul {
            padding-left: 20px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .rules-panel li {
            margin-bottom: 5px;
        }
        
        .controls-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-box h4 {
            color: #ffd700;
            margin-bottom: 8px;
        }
        
        .counter {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }
        
        .btn-check {
            background: linear-gradient(to right, #4caf50, #2e7d32);
            color: white;
            width: 100%;
        }
        
        .btn-check:hover {
            background: linear-gradient(to right, #66bb6a, #388e3c);
            transform: translateY(-2px);
        }
        
        .btn-reset {
            background: linear-gradient(to right, #f44336, #c62828);
            color: white;
            width: 100%;
        }
        
        .btn-reset:hover {
            background: linear-gradient(to right, #ef5350, #d32f2f);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-box .room-order {
            color: #bbbbff;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .info-box .room-themes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            color: #bbbbff;
            font-size: 0.9rem;
        }
        
        .hotel-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            min-height: 500px;
            position: relative;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .hotel {
            position: relative;
            width: 100%;
            min-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
        }
        
        /* å›ºå®šå°äººåŒºåŸŸ */
        .guest-fixed-area {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .guest-label-fixed {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .guest-draggable-fixed {
            display: flex;
            gap: 20px;
        }
        
        .draggable-person {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .draggable-person:active {
            cursor: grabbing;
            transform: scale(1.1);
        }
        
        .draggable-person.up {
            background: linear-gradient(135deg, #2196f3, #0d47a1);
            color: white;
        }
        
        .draggable-person.down {
            background: linear-gradient(135deg, #ff4081, #880e4f);
            color: white;
        }
        
        .hotel-floor {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            position: relative;
            min-height: 130px;
        }
        
        .floor-label {
            width: 80px;
            font-weight: bold;
            font-size: 1.2rem;
            text-align: center;
            color: #ffd700;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .floor-rooms {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            flex: 1;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 120px;
        }
        
        /* æˆ¿é—´ä¸»é¢˜æ ·å¼ - Pæˆ¿é—´æ”¹ä¸ºç±³é»„è‰²é£æ ¼ */
        .room {
            border-radius: 10px;
            padding: 12px;
            min-width: 130px;
            transition: all 0.3s;
            position: relative;
            border: 3px solid;
            flex-shrink: 0;
        }
        
        /* Sæˆ¿é—´ - å…¬ä¸»é£ */
        .room.s-theme {
            background: linear-gradient(135deg, #ffcfe0 0%, #ff9ec0 100%);
            border-color: #ff6b9d;
        }
        
        /* Pæˆ¿é—´ - ç±³é»„è‰²é£æ ¼ */
        .room.p-theme {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-color: #ffb300;
        }
        
        /* Dæˆ¿é—´ - æµ·æ´‹é£ */
        .room.d-theme {
            background: linear-gradient(135deg, #87ceeb 0%, #1e90ff 100%);
            border-color: #000080;
        }
        
        /* Fæˆ¿é—´ - æ£®æ—é£ */
        .room.f-theme {
            background: linear-gradient(135deg, #90ee90 0%, #228b22 100%);
            border-color: #006400;
        }
        
        .room.active {
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .room.invalid {
            animation: shake 0.5s;
            border-color: #ff0000 !important;
        }
        
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
        
        .room-name {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
            font-family: 'Georgia', serif;
        }
        
        .s-theme .room-name {
            background: rgba(255, 255, 255, 0.3);
            color: #d81b60;
        }
        
        .p-theme .room-name {
            background: rgba(0, 0, 0, 0.1);
            color: #ff6f00;
        }
        
        .d-theme .room-name {
            background: rgba(255, 255, 255, 0.3);
            color: #000080;
        }
        
        .f-theme .room-name {
            background: rgba(255, 255, 255, 0.3);
            color: #006400;
        }
        
        .room-beds {
            display: flex;
            flex-direction: row;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .bed {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            padding: 8px;
            width: 80px;
            height: 80px;
            position: relative;
            transition: all 0.3s;
            border: 2px dashed rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }
        
        /* ä¸»é¢˜åºŠä½æ ·å¼ */
        .s-theme .bed {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .p-theme .bed {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .d-theme .bed {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .f-theme .bed {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .bed.occupied {
            border-style: solid;
            border-width: 2px;
        }
        
        .bed.hover-over {
            transform: scale(1.1);
            border-width: 3px;
            border-color: #ffd700 !important;
            background-color: rgba(255, 215, 0, 0.2) !important;
        }
        
        .bed-bedding {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .person {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            transition: all 0.3s;
            position: relative;
        }
        
        .person.up {
            background: linear-gradient(135deg, #2196f3, #0d47a1);
            color: white;
        }
        
        .person.down {
            background: linear-gradient(135deg, #ff4081, #880e4f);
            color: white;
        }
        
        .bed-number {
            position: absolute;
            top: -6px;
            right: -6px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 2;
        }
        
        .room-capacity {
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            padding: 3px;
            border-radius: 5px;
        }
        
        .s-theme .room-capacity {
            background: rgba(255, 255, 255, 0.3);
            color: #d81b60;
        }
        
        .p-theme .room-capacity {
            background: rgba(0, 0, 0, 0.1);
            color: #ff6f00;
        }
        
        .d-theme .room-capacity {
            background: rgba(255, 255, 255, 0.3);
            color: #000080;
        }
        
        .f-theme .room-capacity {
            background: rgba(255, 255, 255, 0.3);
            color: #006400;
        }
        
        /* ç§»é™¤ç”µå­æŒ‰é’® */
        .remove-electron-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }
        
        .bed.occupied:hover .remove-electron-btn {
            display: flex;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 4px solid #ffd700;
        }
        
        .modal h2 {
            font-size: 2rem;
            color: #ff0000;
            margin-bottom: 15px;
        }
        
        .modal p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-btn {
            background: #ffd700;
            color: #1a237e;
            font-size: 1rem;
            font-weight: bold;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .success-modal .modal-content {
            border-color: #4caf50;
        }
        
        .success-modal h2 {
            color: #4caf50;
        }
        
        footer {
            margin-top: 20px;
            text-align: center;
            color: #bbbbff;
            font-size: 0.8rem;
            padding: 10px;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .info-panel {
                grid-template-columns: 1fr;
            }
            
            .guest-fixed-area {
                bottom: 20px;
                right: 20px;
                padding: 10px;
            }
            
            .draggable-person {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .hotel-floor {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .floor-label {
                margin-bottom: 10px;
                width: 100%;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .hotel::-webkit-scrollbar {
            width: 10px;
        }
        
        .hotel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        
        .hotel::-webkit-scrollbar-thumb {
            background: #4a148c;
            border-radius: 5px;
        }
        
        .hotel::-webkit-scrollbar-thumb:hover {
            background: #6a1b9a;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ„é€ åŸç†é…’åº—</h1>
            <p class="subtitle">æ‹–æ‹½å°äººåˆ°åºŠä½ä¸Šå®‰æ’å®¢äººå…¥ä½ã€‚éµå®ˆæ„é€ åŸç†è§„åˆ™ï¼Œé¿å…ç”µå­å¡«å……é”™è¯¯ï¼</p>
        </header>
        
        <div class="top-controls">
            <div class="controls-grid">
                <div class="rules-panel">
                    <h3>å…¥ä½å®ˆåˆ™ï¼š</h3>
                    <ul>
                        <li>ä¸€å¼ åºŠæœ€å¤šç¡ä¸¤ä¸ªäººï¼Œä¸€äººå¤´æœä¸Šï¼Œä¸€äººå¤´æœä¸‹</li>
                        <li>å¿…é¡»ä¸€ä¸ªæˆ¿é—´ä½æ»¡æ‰èƒ½ä½ä¸‹ä¸€ä¸ªæˆ¿é—´</li>
                        <li>æˆ¿é—´è¿˜æœ‰ç©ºåºŠæ—¶ï¼Œä¸å…è®¸ä¸¤äººç¡ä¸€å¼ åºŠ</li>
                        <li>æˆ¿é—´å…¥ä½é¡ºåºï¼š1s â†’ 2s â†’ 2p â†’ 3s â†’ 3p â†’ 4s â†’ 3d</li>
                        <li>ç‰¹æ®Šè§„åˆ™ï¼š4sÂ²3dÂ³åï¼Œ4sä¸­å¤´æœä¸‹çš„ç”µå­éœ€è¦é€€å›é‡æ–°å¡«å……</li>
                        <li>ç¬¬äºŒæ¬¡äº¤å‰ï¼š4sÂ²3dâ¸åï¼Œ4sä¸­å¤´æœä¸‹çš„ç”µå­éœ€è¦å†æ¬¡é€€å›é‡æ–°å¡«å……</li>
                        <li>æˆ¿é—´ä½æ»¡äººæ•°ï¼šs=2äººï¼Œp=6äººï¼Œd=10äººï¼Œf=14äºº</li>
                    </ul>
                </div>
                
                <div class="controls-right">
                    <div class="info-box">
                        <h4>å½“å‰åº”å…¥ä½æˆ¿å·ï¼š</h4>
                        <div class="counter" id="currentRoom">1s (0/2äºº)</div>
                    </div>
                    
                    <div class="info-box">
                        <h4>å·²å…¥ä½å®¢äººï¼š</h4>
                        <div class="counter" id="guestCount">0/36</div>
                    </div>
                    
                    <button class="btn btn-check" id="checkRules">
                        âœ“ æ£€æŸ¥å…¥ä½è§„åˆ™
                    </button>
                    
                    <button class="btn btn-reset" id="resetGame">
                        â†» é‡ç½®æ¸¸æˆ
                    </button>
                </div>
            </div>
            
            <div class="info-panel">
                <div class="info-box">
                    <h4>æˆ¿é—´å…¥ä½é¡ºåºï¼š</h4>
                    <div class="room-order">1s â†’ 2s â†’ 2p â†’ 3s â†’ 3p â†’ 4s â†’ 3d â†’ 4p â†’ 5s â†’ 4d â†’ 5p â†’ 6s â†’ 4f â†’ 5d â†’ 6p â†’ 7s â†’ 5f â†’ 6d â†’ 7p</div>
                </div>
                
                <div class="info-box">
                    <h4>æˆ¿é—´ä¸»é¢˜ï¼š</h4>
                    <div class="room-themes">
                        <div>s = å…¬ä¸»é£</div>
                        <div>p = ç±³é»„é£</div>
                        <div>d = æµ·æ´‹é£</div>
                        <div>f = æ£®æ—é£</div>
                    </div>
                </div>
            </div>
        </div>
        
        <section class="hotel-section">
            <h2 class="section-title">é‡å­é…’åº—æ¥¼å±‚å¸ƒå±€</h2>
            <div class="hotel" id="hotel">
                <!-- é…’åº—æ¥¼å±‚å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- å›ºå®šåœ¨å³ä¸‹è§’çš„å°äººåŒºåŸŸ -->
        <div class="guest-fixed-area">
            <div class="guest-label-fixed">æ‹–æ‹½å°äººåˆ°åºŠä½ä¸Šï¼š</div>
            <div class="guest-draggable-fixed">
                <div class="draggable-person up" id="upGuest" draggable="true">â†‘</div>
                <div class="draggable-person down" id="downGuest" draggable="true">â†“</div>
            </div>
        </div>
        
        <footer>
            <p>æ¸¸æˆè®¾è®¡åŸºäºåŸå­æ„é€ åŸç†ï¼šç”µå­æŒ‰ç…§èƒ½çº§é¡ºåºå¡«å……è½¨é“ï¼Œæ¯ä¸ªè½¨é“æœ€å¤šå®¹çº³ä¸¤ä¸ªè‡ªæ—‹æ–¹å‘ç›¸åçš„ç”µå­</p>
        </footer>
    </div>
    
    <!-- æ¸¸æˆå¤±è´¥æ¨¡æ€æ¡† -->
    <div class="modal" id="deathModal">
        <div class="modal-content">
            <h2>ğŸ’€ ä½ æ­»äº†ï¼</h2>
            <p id="deathMessage">ä½ è¿åäº†é…’åº—å…¥ä½è§„åˆ™ï¼åœ¨é‡å­ä¸–ç•Œä¸­ï¼Œè¿åæ„é€ åŸç†ä¼šå¯¼è‡´åŸå­ä¸ç¨³å®šã€‚</p>
            <p>è¯·é‡æ–°å¼€å§‹æ¸¸æˆï¼Œå¹¶ä¸¥æ ¼éµå®ˆå…¥ä½å®ˆåˆ™ã€‚</p>
            <button class="modal-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    
    <!-- æ¸¸æˆæˆåŠŸæ¨¡æ€æ¡† -->
    <div class="modal success-modal" id="successModal">
        <div class="modal-content">
            <h2>ğŸ‰ æ­å–œï¼</h2>
            <p>ä½ æˆåŠŸå®‰æ’äº† 36 ä½å®¢äººï¼ä½ å®Œå…¨æŒæ¡äº†æ„é€ åŸç†ã€‚</p>
            <p>åŸå­ç»“æ„ç¨³å®šï¼Œé…’åº—è¿è¥è‰¯å¥½ï¼</p>
            <button class="modal-btn" id="continueBtn">ç»§ç»­æ¸¸æˆ</button>
        </div>
    </div>
    
    <script>
        // æ¸¸æˆæ•°æ®
        const gameData = {
            floors: [
                { name: "Kå±‚", rooms: [{ name: "1s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }] },
                { name: "Lå±‚", rooms: [{ name: "2s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "2p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }] },
                { name: "Må±‚", rooms: [{ name: "3s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "3p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }, { name: "3d", beds: 5, type: "d", maxOccupants: 10, theme: "d-theme" }] },
                { name: "Nå±‚", rooms: [{ name: "4s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "4p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }, { name: "4d", beds: 5, type: "d", maxOccupants: 10, theme: "d-theme" }, { name: "4f", beds: 7, type: "f", maxOccupants: 14, theme: "f-theme" }] },
                { name: "Oå±‚", rooms: [{ name: "5s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "5p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }, { name: "5d", beds: 5, type: "d", maxOccupants: 10, theme: "d-theme" }, { name: "5f", beds: 7, type: "f", maxOccupants: 14, theme: "f-theme" }] },
                { name: "På±‚", rooms: [{ name: "6s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "6p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }, { name: "6d", beds: 5, type: "d", maxOccupants: 10, theme: "d-theme" }] },
                { name: "Qå±‚", rooms: [{ name: "7s", beds: 1, type: "s", maxOccupants: 2, theme: "s-theme" }, { name: "7p", beds: 3, type: "p", maxOccupants: 6, theme: "p-theme" }] }
            ],
            
            // æ„é€ åŸç†å¡«å……é¡ºåº
            roomOrder: [
                "1s", "2s", "2p", "3s", "3p", 
                "4s", "3d", "4p", "5s", "4d", 
                "5p", "6s", "4f", "5d", "6p", 
                "7s", "5f", "6d", "7p"
            ],
            
            currentState: {
                totalOccupants: 0,
                currentRoomIndex: 0,
                occupiedBeds: {},
                roomStatus: {},
                specialState: {
                    needRemove4sElectron: false,
                    removed4sElectron: false,
                    crossoverStep: 0,  // 0=æ— äº¤å‰, 1=ç¬¬ä¸€æ¬¡äº¤å‰, 2=ç¬¬äºŒæ¬¡äº¤å‰
                    firstCrossoverCompleted: false,
                    secondCrossoverTriggered: false,
                    secondCrossoverCompleted: false
                }
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameData.currentState = {
                totalOccupants: 0,
                currentRoomIndex: 0,
                occupiedBeds: {},
                roomStatus: {},
                specialState: {
                    needRemove4sElectron: false,
                    removed4sElectron: false,
                    crossoverStep: 0,
                    firstCrossoverCompleted: false,
                    secondCrossoverTriggered: false,
                    secondCrossoverCompleted: false
                }
            };
            
            gameData.floors.forEach(floor => {
                floor.rooms.forEach(room => {
                    gameData.currentState.roomStatus[room.name] = {
                        filledBeds: 0,
                        totalBeds: room.beds,
                        maxOccupants: room.maxOccupants,
                        currentOccupants: 0
                    };
                });
            });
            
            updateGuestCount();
            updateCurrentRoom();
            renderHotel();
            initDragAndDrop();
            
            document.getElementById("checkRules").disabled = false;
        }

        // æ¸²æŸ“é…’åº—
        function renderHotel() {
            const hotelEl = document.getElementById("hotel");
            hotelEl.innerHTML = "";
            
            gameData.floors.forEach(floor => {
                const floorEl = document.createElement("div");
                floorEl.className = "hotel-floor";
                
                const floorLabel = document.createElement("div");
                floorLabel.className = "floor-label";
                floorLabel.textContent = floor.name;
                floorEl.appendChild(floorLabel);
                
                const roomsContainer = document.createElement("div");
                roomsContainer.className = "floor-rooms";
                
                floor.rooms.forEach(room => {
                    const roomEl = createRoomElement(room);
                    roomsContainer.appendChild(roomEl);
                });
                
                floorEl.appendChild(roomsContainer);
                hotelEl.appendChild(floorEl);
            });
        }

        // åˆ›å»ºæˆ¿é—´å…ƒç´ 
        function createRoomElement(room) {
            const roomEl = document.createElement("div");
            const roomStatus = gameData.currentState.roomStatus[room.name];
            
            roomEl.className = `room ${room.theme}`;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰åº”å…¥ä½çš„æˆ¿é—´
            const currentRoomName = getCurrentRoom();
            if (room.name === currentRoomName) {
                roomEl.classList.add("active");
            }
            
            // ç‰¹æ®ŠçŠ¶æ€ï¼šå¦‚æœ4sæˆ¿é—´éœ€è¦ç§»é™¤ç”µå­ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
            const specialState = gameData.currentState.specialState;
            if (room.name === "4s" && specialState.needRemove4sElectron) {
                roomEl.style.boxShadow = "0 0 15px #ff0000";
            }
            
            const roomNameEl = document.createElement("div");
            roomNameEl.className = "room-name";
            roomNameEl.textContent = room.name;
            roomEl.appendChild(roomNameEl);
            
            const bedsContainer = document.createElement("div");
            bedsContainer.className = "room-beds";
            
            // åºŠä½ä»å·¦åˆ°å³æ’åˆ—
            for (let i = 0; i < room.beds; i++) {
                const bedEl = createBedElement(room.name, i);
                bedsContainer.appendChild(bedEl);
            }
            
            roomEl.appendChild(bedsContainer);
            
            const capacityEl = document.createElement("div");
            capacityEl.className = "room-capacity";
            capacityEl.textContent = `å·²ä½: ${roomStatus.currentOccupants}/${roomStatus.maxOccupants}äºº`;
            roomEl.appendChild(capacityEl);
            
            return roomEl;
        }

        // åˆ›å»ºåºŠä½å…ƒç´ 
        function createBedElement(roomName, bedIndex) {
            const bedEl = document.createElement("div");
            bedEl.className = "bed";
            bedEl.dataset.room = roomName;
            bedEl.dataset.bedIndex = bedIndex;
            
            const bedKey = `${roomName}-${bedIndex}`;
            const occupants = gameData.currentState.occupiedBeds[bedKey] || [];
            
            // åºŠä½ç¼–å·
            const bedNumber = document.createElement("div");
            bedNumber.className = "bed-number";
            bedNumber.textContent = bedIndex + 1;
            bedEl.appendChild(bedNumber);
            
            const beddingEl = document.createElement("div");
            beddingEl.className = "bed-bedding";
            
            if (occupants.length > 0) {
                bedEl.classList.add("occupied");
                
                occupants.forEach((direction, index) => {
                    const personEl = document.createElement("div");
                    personEl.className = `person ${direction}`;
                    personEl.textContent = direction === "up" ? "â†‘" : "â†“";
                    personEl.dataset.room = roomName;
                    personEl.dataset.bedIndex = bedIndex;
                    personEl.dataset.position = index;
                    
                    // å…³é”®ä¿®å¤ï¼šåœ¨ç¬¬äºŒæ¬¡äº¤å‰æ—¶ä¹Ÿæ˜¾ç¤ºç§»é™¤æŒ‰é’®
                    const specialState = gameData.currentState.specialState;
                    if (roomName === "4s" && direction === "down" && 
                        specialState.needRemove4sElectron && 
                        (specialState.crossoverStep === 1 || specialState.crossoverStep === 2)) {
                        const removeBtn = document.createElement("div");
                        removeBtn.className = "remove-electron-btn";
                        removeBtn.textContent = "Ã—";
                        
                        if (specialState.crossoverStep === 1) {
                            removeBtn.title = "ç‚¹å‡»ç§»é™¤è¿™ä¸ªç”µå­ï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼š4sÂ²3dÂ³ï¼‰";
                        } else if (specialState.crossoverStep === 2) {
                            removeBtn.title = "ç‚¹å‡»ç§»é™¤è¿™ä¸ªç”µå­ï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼š4sÂ²3dâ¸ï¼‰";
                        }
                        
                        removeBtn.addEventListener("click", function(e) {
                            e.stopPropagation();
                            removeElectronFromBed(roomName, bedIndex, index);
                        });
                        bedEl.appendChild(removeBtn);
                    }
                    
                    beddingEl.appendChild(personEl);
                });
            }
            
            bedEl.appendChild(beddingEl);
            
            return bedEl;
        }

        // ä»åºŠä½ç§»é™¤ç”µå­
        function removeElectronFromBed(roomName, bedIndex, position) {
            const bedKey = `${roomName}-${bedIndex}`;
            const occupants = gameData.currentState.occupiedBeds[bedKey];
            
            if (!occupants || occupants.length <= position) {
                return false;
            }
            
            // ç§»é™¤æŒ‡å®šä½ç½®çš„ç”µå­
            occupants.splice(position, 1);
            
            // æ›´æ–°æˆ¿é—´çŠ¶æ€
            const roomStatus = gameData.currentState.roomStatus[roomName];
            roomStatus.currentOccupants--;
            
            // å¦‚æœåºŠä½å˜ç©ºï¼Œæ›´æ–°filledBeds
            if (occupants.length === 0) {
                roomStatus.filledBeds--;
                delete gameData.currentState.occupiedBeds[bedKey];
            }
            
            // å‡å°‘æ€»å®¢äººæ•°
            gameData.currentState.totalOccupants--;
            
            const specialState = gameData.currentState.specialState;
            
            // ç‰¹æ®ŠçŠ¶æ€å¤„ç†ï¼šå¦‚æœç§»é™¤äº†4sçš„ç”µå­
            if (roomName === "4s" && specialState.needRemove4sElectron) {
                specialState.needRemove4sElectron = false;
                specialState.removed4sElectron = true;
                
                // æ›´æ–°å½“å‰æˆ¿é—´ç´¢å¼•åˆ°3d
                const threeDIndex = gameData.roomOrder.indexOf("3d");
                if (threeDIndex !== -1) {
                    gameData.currentState.currentRoomIndex = threeDIndex;
                }
            }
            
            // æ›´æ–°UI
            updateGuestCount();
            updateCurrentRoom();
            renderHotel();
            initDragAndDrop();
            
            return true;
        }

        // æ£€æŸ¥äº¤å‰è§¦å‘æ¡ä»¶ - ä¿®å¤äº†ç¬¬äºŒæ¬¡äº¤å‰çš„é€»è¾‘
        function checkCrossoverTriggers() {
            const specialState = gameData.currentState.specialState;
            const roomStatus = gameData.currentState.roomStatus;
            
            const fourS = roomStatus["4s"] ? roomStatus["4s"].currentOccupants : 0;
            const threeD = roomStatus["3d"] ? roomStatus["3d"].currentOccupants : 0;
            
            // å¦‚æœå·²ç»éœ€è¦ç§»é™¤ç”µå­ï¼Œä¸é‡å¤è§¦å‘
            if (specialState.needRemove4sElectron) {
                return;
            }
            
            // æ£€æŸ¥ç¬¬ä¸€æ¬¡äº¤å‰ï¼š4sÂ²3dÂ³
            if (fourS === 2 && threeD === 3 && !specialState.firstCrossoverCompleted) {
                specialState.needRemove4sElectron = true;
                specialState.crossoverStep = 1;
                return;
            }
            
            // å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç¬¬äºŒæ¬¡äº¤å‰ï¼š4sÂ²3dâ¸
            // åªè¦æ»¡è¶³æ¡ä»¶å°±è§¦å‘ï¼Œä¸éœ€è¦æ£€æŸ¥firstCrossoverCompleted
            if (fourS === 2 && threeD === 8 && !specialState.secondCrossoverCompleted) {
                specialState.needRemove4sElectron = true;
                specialState.crossoverStep = 2;
                specialState.secondCrossoverTriggered = true;
                return;
            }
        }

        // è·å–å½“å‰åº”å…¥ä½çš„æˆ¿é—´ - ä¿®å¤äº†ç¬¬äºŒæ¬¡äº¤å‰çš„é€»è¾‘
        function getCurrentRoom() {
            const specialState = gameData.currentState.specialState;
            
            // å¦‚æœå·²ç»è§¦å‘äº†äº¤å‰ä¸”éœ€è¦ç§»é™¤ç”µå­ï¼Œè¿”å›4s
            if (specialState.needRemove4sElectron) {
                return "4s";
            }
            
            // å¦‚æœ4sç”µå­å·²ç§»é™¤ï¼Œæ ¹æ®äº¤å‰æ­¥éª¤å¤„ç†
            if (specialState.removed4sElectron) {
                const roomStatus = gameData.currentState.roomStatus;
                const fourS = roomStatus["4s"] ? roomStatus["4s"].currentOccupants : 0;
                const threeD = roomStatus["3d"] ? roomStatus["3d"].currentOccupants : 0;
                
                if (specialState.crossoverStep === 1) {
                    // ç¬¬ä¸€æ¬¡äº¤å‰é€»è¾‘
                    if (threeD < 5) {
                        return "3d";
                    } else if (threeD === 5 && fourS === 1) {
                        return "4s";
                    } else if (threeD === 5 && fourS === 2) {
                        return "3d";
                    } else if (threeD === 10) {
                        specialState.removed4sElectron = false;
                        specialState.crossoverStep = 0;
                        specialState.firstCrossoverCompleted = true;
                        
                        // å®Œæˆç¬¬ä¸€æ¬¡äº¤å‰åï¼Œåº”è¯¥ç»§ç»­å¡«å……4p
                        const fourPIndex = gameData.roomOrder.indexOf("4p");
                        if (fourPIndex !== -1) {
                            gameData.currentState.currentRoomIndex = fourPIndex;
                        }
                        return "4p";
                    }
                } else if (specialState.crossoverStep === 2) {
                    // ç¬¬äºŒæ¬¡äº¤å‰é€»è¾‘
                    if (threeD < 10) {
                        return "3d";
                    } else if (threeD === 10 && fourS === 1) {
                        return "4s";
                    } else if (threeD === 10 && fourS === 2) {
                        specialState.removed4sElectron = false;
                        specialState.crossoverStep = 0;
                        specialState.secondCrossoverCompleted = true;
                        
                        // ç¬¬äºŒæ¬¡äº¤å‰å®Œæˆåï¼Œåº”è¯¥ç»§ç»­å¡«å……4pï¼ˆå¦‚æœ4pæœªæ»¡ï¼‰
                        const fourPStatus = roomStatus["4p"];
                        if (fourPStatus && fourPStatus.currentOccupants < fourPStatus.maxOccupants) {
                            const fourPIndex = gameData.roomOrder.indexOf("4p");
                            if (fourPIndex !== -1) {
                                gameData.currentState.currentRoomIndex = fourPIndex;
                            }
                            return "4p";
                        } else {
                            // å¦‚æœ4på·²æ»¡ï¼Œæ‰¾ä¸‹ä¸€ä¸ªæˆ¿é—´
                            return findNextRoom();
                        }
                    }
                }
            }
            
            // å¦åˆ™è¿”å›æ­£å¸¸çš„å¡«å……é¡ºåº
            return findNextRoom();
        }

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåº”å…¥ä½çš„æˆ¿é—´
        function findNextRoom() {
            const roomStatus = gameData.currentState.roomStatus;
            const currentIndex = gameData.currentState.currentRoomIndex;
            
            // ä»å½“å‰ç´¢å¼•å¼€å§‹æŸ¥æ‰¾
            for (let i = currentIndex; i < gameData.roomOrder.length; i++) {
                const roomName = gameData.roomOrder[i];
                const status = roomStatus[roomName];
                
                if (status && status.currentOccupants < status.maxOccupants) {
                    gameData.currentState.currentRoomIndex = i;
                    return roomName;
                }
            }
            
            // å¦‚æœéƒ½æ»¡äº†ï¼Œè¿”å›æœ€åä¸€ä¸ªæˆ¿é—´
            return gameData.roomOrder[Math.min(currentIndex, gameData.roomOrder.length - 1)];
        }

        // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å·²æ»¡ï¼Œæ›´æ–°å½“å‰æˆ¿é—´ç´¢å¼•
        function checkAndUpdateRoomStatus(roomName) {
            const roomStatus = gameData.currentState.roomStatus[roomName];
            const specialState = gameData.currentState.specialState;
            
            // ç‰¹æ®ŠçŠ¶æ€å¤„ç†
            if (specialState.needRemove4sElectron && roomName === "4s") {
                // ç­‰å¾…ç”¨æˆ·ç§»é™¤4sçš„ç”µå­
                return;
            }
            
            if (specialState.removed4sElectron) {
                // å¤„ç†äº¤å‰å¡«å……
                if (specialState.crossoverStep === 1) {
                    // ç¬¬ä¸€æ¬¡äº¤å‰
                    if (roomName === "3d" && roomStatus.currentOccupants === 5) {
                        return;
                    }
                    
                    if (roomName === "4s" && roomStatus.currentOccupants === 2) {
                        return;
                    }
                    
                    if (roomName === "3d" && roomStatus.currentOccupants === 10) {
                        specialState.removed4sElectron = false;
                        specialState.crossoverStep = 0;
                        specialState.firstCrossoverCompleted = true;
                        
                        // æ›´æ–°æˆ¿é—´ç´¢å¼•åˆ°4p
                        const fourPIndex = gameData.roomOrder.indexOf("4p");
                        if (fourPIndex !== -1) {
                            gameData.currentState.currentRoomIndex = fourPIndex;
                        }
                    }
                } else if (specialState.crossoverStep === 2) {
                    // ç¬¬äºŒæ¬¡äº¤å‰
                    if (roomName === "3d" && roomStatus.currentOccupants === 10) {
                        return;
                    }
                    
                    if (roomName === "4s" && roomStatus.currentOccupants === 2) {
                        specialState.removed4sElectron = false;
                        specialState.crossoverStep = 0;
                        specialState.secondCrossoverCompleted = true;
                        
                        // æ›´æ–°æˆ¿é—´ç´¢å¼•åˆ°4p
                        const fourPIndex = gameData.roomOrder.indexOf("4p");
                        if (fourPIndex !== -1) {
                            gameData.currentState.currentRoomIndex = fourPIndex;
                        }
                    }
                }
            }
            
            // æ­£å¸¸å¡«å……é€»è¾‘
            if (roomStatus.currentOccupants === roomStatus.maxOccupants && !specialState.removed4sElectron) {
                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªæ»¡çš„æˆ¿é—´
                findNextRoom();
            }
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
            const upGuest = document.getElementById('upGuest');
            const downGuest = document.getElementById('downGuest');
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUpGuest = upGuest.cloneNode(true);
            const newDownGuest = downGuest.cloneNode(true);
            
            upGuest.parentNode.replaceChild(newUpGuest, upGuest);
            downGuest.parentNode.replaceChild(newDownGuest, downGuest);
            
            // ä¸ºå°äººæ·»åŠ æ‹–æ‹½äº‹ä»¶
            document.getElementById('upGuest').addEventListener('dragstart', handleDragStart);
            document.getElementById('downGuest').addEventListener('dragstart', handleDragStart);
            
            // ä¸ºæ‰€æœ‰åºŠä½æ·»åŠ æ‹–æ‹½äº‹ä»¶
            const beds = document.querySelectorAll('.bed');
            beds.forEach(bed => {
                bed.addEventListener('dragover', handleDragOver);
                bed.addEventListener('dragenter', handleDragEnter);
                bed.addEventListener('dragleave', handleDragLeave);
                bed.addEventListener('drop', handleDrop);
            });
            
            // é˜²æ­¢é»˜è®¤è¡Œä¸º
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
            });
        }

        // æ‹–æ‹½å¼€å§‹å¤„ç†
        function handleDragStart(e) {
            const direction = e.target.id === 'upGuest' ? 'up' : 'down';
            e.dataTransfer.setData('direction', direction);
            e.dataTransfer.effectAllowed = 'move';
            
            // åˆ›å»ºæ‹–æ‹½æ•ˆæœ
            e.target.style.opacity = '0.7';
            
            // 5ç§’åæ¢å¤é€æ˜åº¦ï¼ˆé˜²æ­¢å¡ä½ï¼‰
            setTimeout(() => {
                e.target.style.opacity = '1';
            }, 5000);
        }

        // æ‹–æ‹½æ‚¬åœå¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            if (e.target.classList.contains('bed')) {
                e.dataTransfer.dropEffect = 'move';
            }
        }

        // æ‹–æ‹½è¿›å…¥å¤„ç†
        function handleDragEnter(e) {
            if (e.target.classList.contains('bed')) {
                e.target.classList.add('hover-over');
            }
        }

        // æ‹–æ‹½ç¦»å¼€å¤„ç†
        function handleDragLeave(e) {
            if (e.target.classList.contains('bed')) {
                e.target.classList.remove('hover-over');
            }
        }

        // æ”¾ç½®å¤„ç†
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // ç§»é™¤æ‚¬åœæ•ˆæœ
            const beds = document.querySelectorAll('.bed');
            beds.forEach(bed => bed.classList.remove('hover-over'));
            
            let bedElement = e.target;
            // å¦‚æœç‚¹å‡»çš„æ˜¯åºŠä½å†…éƒ¨çš„å…ƒç´ ï¼Œæ‰¾åˆ°çˆ¶åºŠä½å…ƒç´ 
            while (bedElement && !bedElement.classList.contains('bed')) {
                bedElement = bedElement.parentElement;
            }
            
            if (!bedElement || !bedElement.classList.contains('bed')) {
                // æ¢å¤å°äººçš„æ˜¾ç¤º
                document.getElementById('upGuest').style.opacity = '1';
                document.getElementById('downGuest').style.opacity = '1';
                return;
            }
            
            try {
                const direction = e.dataTransfer.getData('direction');
                const roomName = bedElement.dataset.room;
                const bedIndex = parseInt(bedElement.dataset.bedIndex);
                
                // åˆ†é…å®¢äººåˆ°åºŠä½
                const success = assignGuestToBed(roomName, bedIndex, direction);
                
                // æ¢å¤å°äººçš„æ˜¾ç¤º
                document.getElementById('upGuest').style.opacity = '1';
                document.getElementById('downGuest').style.opacity = '1';
                
                if (success) {
                    // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    setTimeout(initDragAndDrop, 10);
                }
            } catch (error) {
                console.error("æ”¾ç½®é”™è¯¯:", error);
                // æ¢å¤å°äººçš„æ˜¾ç¤º
                document.getElementById('upGuest').style.opacity = '1';
                document.getElementById('downGuest').style.opacity = '1';
            }
        }

        // åˆ†é…å®¢äººåˆ°åºŠä½
        function assignGuestToBed(roomName, bedIndex, direction) {
            const currentRoom = getCurrentRoom();
            const roomStatus = gameData.currentState.roomStatus[roomName];
            const specialState = gameData.currentState.specialState;
            
            // æ£€æŸ¥æ˜¯å¦æŒ‰é¡ºåºå…¥ä½
            if (roomName !== currentRoom) {
                // ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœ4séœ€è¦ç§»é™¤ç”µå­ï¼Œä¸èƒ½ç»§ç»­å¡«å……
                if (specialState.needRemove4sElectron) {
                    const message = specialState.crossoverStep === 1 ? 
                        "å¿…é¡»å…ˆç§»é™¤4sæˆ¿é—´ä¸­çš„ä¸€ä¸ªç”µå­ï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼š4sÂ²3dÂ³åéœ€è¦è°ƒæ•´ï¼‰ï¼" :
                        "å¿…é¡»å…ˆç§»é™¤4sæˆ¿é—´ä¸­çš„ä¸€ä¸ªç”µå­ï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼š4sÂ²3dâ¸åéœ€è¦è°ƒæ•´ï¼‰ï¼";
                    showDeathModal(message);
                    return false;
                }
                
                const currentRoomStatus = gameData.currentState.roomStatus[currentRoom];
                if (currentRoomStatus && currentRoomStatus.currentOccupants < currentRoomStatus.maxOccupants) {
                    showDeathModal(`å¿…é¡»ä½æ»¡ ${currentRoom} æˆ¿é—´ï¼ˆ${currentRoomStatus.currentOccupants}/${currentRoomStatus.maxOccupants}äººï¼‰æ‰èƒ½å…¥ä½ ${roomName} æˆ¿é—´ï¼`);
                    return false;
                }
            }
            
            const bedKey = `${roomName}-${bedIndex}`;
            const occupants = gameData.currentState.occupiedBeds[bedKey] || [];
            
            if (occupants.length >= 2) {
                showDeathModal("ä¸€å¼ åºŠæœ€å¤šåªèƒ½ç¡ä¸¤ä¸ªäººï¼");
                return false;
            }
            
            if (roomStatus.filledBeds < roomStatus.totalBeds && occupants.length === 1) {
                showDeathModal("æˆ¿é—´è¿˜æœ‰ç©ºåºŠï¼Œä¸å…è®¸ä¸¤ä¸ªäººç¡ä¸€å¼ åºŠï¼");
                return false;
            }
            
            if (roomStatus.currentOccupants >= roomStatus.maxOccupants) {
                showDeathModal(`${roomName} æˆ¿é—´å·²ç»ä½æ»¡äº†ï¼`);
                return false;
            }
            
            // ç‰¹æ®Šæƒ…å†µå¤„ç†
            const isSpecial4sCase = (roomName === "4s" && 
                                   specialState.removed4sElectron && 
                                   ((specialState.crossoverStep === 1 && gameData.currentState.roomStatus["3d"]?.currentOccupants === 5) ||
                                    (specialState.crossoverStep === 2 && gameData.currentState.roomStatus["3d"]?.currentOccupants === 10)) &&
                                   roomStatus.currentOccupants === 1);
            
            if (occupants.length === 0 && direction !== "up" && !isSpecial4sCase) {
                showDeathModal("ç¬¬ä¸€ä¸ªå…¥ä½è¿™å¼ åºŠçš„å®¢äººå¿…é¡»å¤´æœä¸Šï¼");
                return false;
            }
            
            if (occupants.length === 1 && direction !== "down" && !isSpecial4sCase) {
                showDeathModal("ç¬¬äºŒä¸ªå…¥ä½è¿™å¼ åºŠçš„å®¢äººå¿…é¡»å¤´æœä¸‹ï¼");
                return false;
            }
            
            // ç‰¹æ®Šæ£€æŸ¥ï¼šå¦‚æœ4séœ€è¦ç§»é™¤ç”µå­ï¼Œä¸èƒ½ç»§ç»­å¡«å……4s
            if (roomName === "4s" && specialState.needRemove4sElectron) {
                const message = specialState.crossoverStep === 1 ? 
                    "å¿…é¡»å…ˆç§»é™¤4sæˆ¿é—´ä¸­çš„ä¸€ä¸ªç”µå­ï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼‰æ‰èƒ½ç»§ç»­å¡«å……ï¼" :
                    "å¿…é¡»å…ˆç§»é™¤4sæˆ¿é—´ä¸­çš„ä¸€ä¸ªç”µå­ï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼‰æ‰èƒ½ç»§ç»­å¡«å……ï¼";
                showDeathModal(message);
                return false;
            }
            
            // åˆ†é…å®¢äºº
            if (!gameData.currentState.occupiedBeds[bedKey]) {
                gameData.currentState.occupiedBeds[bedKey] = [];
            }
            gameData.currentState.occupiedBeds[bedKey].push(direction);
            
            // æ›´æ–°æˆ¿é—´çŠ¶æ€
            roomStatus.currentOccupants++;
            if (occupants.length === 0) {
                roomStatus.filledBeds++;
            }
            
            // å¢åŠ æ€»å®¢äººæ•°
            gameData.currentState.totalOccupants++;
            
            // å…³é”®ä¿®å¤ï¼šåœ¨åˆ†é…ç”µå­åæ£€æŸ¥æ˜¯å¦è§¦å‘äº¤å‰
            checkCrossoverTriggers();
            
            // æ£€æŸ¥å’Œæ›´æ–°æˆ¿é—´çŠ¶æ€
            checkAndUpdateRoomStatus(roomName);
            
            // æ›´æ–°UI
            updateGuestCount();
            updateCurrentRoom();
            renderHotel();
            
            checkAllRules();
            checkVictory();
            
            return true;
        }

        // æ£€æŸ¥æ‰€æœ‰è§„åˆ™
        function checkAllRules() {
            let isValid = true;
            let errorMessage = "";
            
            // è§„åˆ™1ï¼šæ£€æŸ¥æ˜¯å¦æœ‰åºŠä½è¶…è¿‡2äºº
            Object.keys(gameData.currentState.occupiedBeds).forEach(bedKey => {
                if (gameData.currentState.occupiedBeds[bedKey].length > 2) {
                    isValid = false;
                    errorMessage = "ä¸€å¼ åºŠæœ€å¤šåªèƒ½ç¡ä¸¤ä¸ªäººï¼";
                }
            });
            
            // è§„åˆ™2ï¼šæ£€æŸ¥æ˜¯å¦æŒ‰é¡ºåºå…¥ä½
            const specialState = gameData.currentState.specialState;
            
            if (!specialState.needRemove4sElectron && !specialState.removed4sElectron) {
                for (let i = 0; i < gameData.roomOrder.length; i++) {
                    const roomName = gameData.roomOrder[i];
                    const roomStatus = gameData.currentState.roomStatus[roomName];
                    
                    if (!roomStatus) continue;
                    
                    if (roomStatus.currentOccupants < roomStatus.maxOccupants) {
                        for (let j = i + 1; j < gameData.roomOrder.length; j++) {
                            const nextRoomName = gameData.roomOrder[j];
                            const nextRoomStatus = gameData.currentState.roomStatus[nextRoomName];
                            
                            if (nextRoomStatus && nextRoomStatus.currentOccupants > 0) {
                                isValid = false;
                                errorMessage = `${roomName} æˆ¿é—´æœªä½æ»¡ï¼Œä½† ${nextRoomName} æˆ¿é—´å·²æœ‰äººå…¥ä½ï¼`;
                                break;
                            }
                        }
                        if (!isValid) break;
                    }
                }
            }
            
            // è§„åˆ™3ï¼šæ£€æŸ¥æ˜¯å¦åœ¨æœ‰ç©ºåºŠçš„æƒ…å†µä¸‹ä¸¤äººç¡ä¸€å¼ åºŠ
            Object.keys(gameData.currentState.roomStatus).forEach(roomName => {
                const roomStatus = gameData.currentState.roomStatus[roomName];
                
                if (roomStatus.filledBeds < roomStatus.totalBeds) {
                    for (let i = 0; i < roomStatus.totalBeds; i++) {
                        const bedKey = `${roomName}-${i}`;
                        const occupants = gameData.currentState.occupiedBeds[bedKey] || [];
                        if (occupants.length > 1) {
                            isValid = false;
                            errorMessage = `${roomName} æˆ¿é—´è¿˜æœ‰ç©ºåºŠï¼Œä½†æœ‰ä¸€å¼ åºŠç¡äº†ä¸¤ä¸ªäººï¼`;
                            break;
                        }
                    }
                }
            });
            
            if (!isValid) {
                showDeathModal(errorMessage);
                return false;
            }
            
            return true;
        }

        // æ˜¾ç¤ºæ­»äº¡æ¨¡æ€æ¡†
        function showDeathModal(message) {
            const modal = document.getElementById("deathModal");
            const deathMessage = document.getElementById("deathMessage");
            
            if (message) {
                deathMessage.innerHTML = `ä½ è¿åäº†é…’åº—å…¥ä½è§„åˆ™ï¼<br>${message}<br>åœ¨é‡å­ä¸–ç•Œä¸­ï¼Œè¿åæ„é€ åŸç†ä¼šå¯¼è‡´åŸå­ä¸ç¨³å®šã€‚`;
            }
            
            modal.style.display = "flex";
            
            document.getElementById("checkRules").disabled = true;
            
            // æ ‡è®°è¿è§„çš„æˆ¿é—´
            setTimeout(() => {
                const currentRoomName = getCurrentRoom();
                const rooms = document.querySelectorAll(".room");
                rooms.forEach(room => {
                    const roomNameEl = room.querySelector('.room-name');
                    if (roomNameEl && roomNameEl.textContent === currentRoomName) {
                        room.classList.add("invalid");
                    }
                });
            }, 100);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¨¡æ€æ¡†
        function showSuccessModal() {
            const modal = document.getElementById("successModal");
            modal.style.display = "flex";
        }

        // æ›´æ–°å®¢äººæ•°é‡æ˜¾ç¤º
        function updateGuestCount() {
            const totalOccupants = Object.values(gameData.currentState.roomStatus).reduce(
                (sum, room) => sum + room.currentOccupants, 0
            );
            document.getElementById("guestCount").textContent = `${totalOccupants}/36`;
        }

        // æ›´æ–°å½“å‰æˆ¿é—´æ˜¾ç¤º
        function updateCurrentRoom() {
            const currentRoomName = getCurrentRoom();
            const roomStatus = gameData.currentState.roomStatus[currentRoomName];
            const specialState = gameData.currentState.specialState;
            
            let displayText = currentRoomName;
            
            if (specialState.needRemove4sElectron) {
                const suffix = specialState.crossoverStep === 1 ? "ï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼šéœ€è¦ç§»é™¤ä¸€ä¸ªç”µå­ï¼‰" : "ï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼šéœ€è¦ç§»é™¤ä¸€ä¸ªç”µå­ï¼‰";
                displayText = "4s " + suffix;
            } else if (specialState.removed4sElectron) {
                if (currentRoomName === "3d") {
                    const threeDCount = roomStatus ? roomStatus.currentOccupants : 0;
                    const fourSCount = gameData.currentState.roomStatus["4s"] ? gameData.currentState.roomStatus["4s"].currentOccupants : 0;
                    
                    if (specialState.crossoverStep === 1 && threeDCount === 5 && fourSCount === 1) {
                        displayText = "4sï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼šå¡«å……ç¬¬äºŒä¸ªç”µå­ï¼‰";
                    } else if (specialState.crossoverStep === 2 && threeDCount === 10 && fourSCount === 1) {
                        displayText = "4sï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼šå¡«å……ç¬¬äºŒä¸ªç”µå­ï¼‰";
                    } else if (roomStatus) {
                        displayText = `${currentRoomName} (${roomStatus.currentOccupants}/${roomStatus.maxOccupants}äºº)`;
                    }
                } else if (currentRoomName === "4s") {
                    const suffix = specialState.crossoverStep === 1 ? "ï¼ˆç¬¬ä¸€æ¬¡äº¤å‰ï¼šå¡«å……ç¬¬äºŒä¸ªç”µå­ï¼‰" : "ï¼ˆç¬¬äºŒæ¬¡äº¤å‰ï¼šå¡«å……ç¬¬äºŒä¸ªç”µå­ï¼‰";
                    displayText = "4s " + suffix;
                } else if (roomStatus) {
                    displayText = `${currentRoomName} (${roomStatus.currentOccupants}/${roomStatus.maxOccupants}äºº)`;
                }
            } else if (roomStatus) {
                displayText = `${currentRoomName} (${roomStatus.currentOccupants}/${roomStatus.maxOccupants}äºº)`;
            } else {
                displayText = `${currentRoomName} (0/2äºº)`;
            }
            
            document.getElementById("currentRoom").textContent = displayText;
        }

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦èƒœåˆ©
        function checkVictory() {
            let totalOccupants = 0;
            
            for (const roomName in gameData.currentState.roomStatus) {
                const roomStatus = gameData.currentState.roomStatus[roomName];
                totalOccupants += roomStatus.currentOccupants;
            }
            
            // ä¿®æ”¹èƒœåˆ©æ¡ä»¶ï¼šæ€»äººæ•°è¾¾åˆ°36äººä¸”è§„åˆ™æ£€æŸ¥é€šè¿‡
            if (totalOccupants === 36 && checkAllRules()) {
                setTimeout(() => {
                    showSuccessModal();
                }, 500);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById("checkRules").addEventListener("click", () => {
            if (checkAllRules()) {
                alert("æ‰€æœ‰è§„åˆ™éƒ½ç¬¦åˆï¼ç»§ç»­å®‰æ’å®¢äººå§ã€‚");
                checkVictory();
            }
        });
        
        document.getElementById("resetGame").addEventListener("click", () => {
            if (confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦éƒ½ä¼šä¸¢å¤±ã€‚")) {
                initGame();
            }
        });
        
        document.getElementById("restartBtn").addEventListener("click", () => {
            document.getElementById("deathModal").style.display = "none";
            initGame();
        });
        
        document.getElementById("continueBtn").addEventListener("click", () => {
            document.getElementById("successModal").style.display = "none";
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = initGame;
    </script>
</body>
</html>